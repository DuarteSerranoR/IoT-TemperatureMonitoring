""" Fastapi service to compute the ML temperature prediction models. """

import pickle
from typing import List
import __main__

import torch
import uvicorn
import numpy as np
from fastapi import FastAPI
from fastapi.responses import JSONResponse
from fastapi.encoders import jsonable_encoder
from pydantic import BaseModel

from models import LSTM, CustomRandomForestRegressor

class SingleRequest(BaseModel):
    """ Base Model for Single temperature Requests. """

    current_temperature_outside: float
    current_temperature_inside: float = None
    current_datetime: str

class BatchRequest(BaseModel):
    """ Base Model for Batched temperature Requests. """

    temperature_sequence_outside: List[float]
    current_temperature_inside: float = None
    current_datetime: str

setattr(__main__, "LSTM", LSTM)
setattr(__main__, "CustomRandomForestRegressor", CustomRandomForestRegressor)

with open("./outside_model/model_v3.1-torch","rb") as o:
    outside_model: LSTM = \
        torch.load(o, encoding='bytes', map_location="cpu")

print("Outside Model:")
print(outside_model)
outside_model.set_device("cpu")
print(outside_model.predict(np.array([
15.25,
24.25,
24.187,
15.367,
14.383,
24.5,
13.567,
24.25,
13.156,
24.562,
24.562,
12.922,
24.312,
12.189,
24.0,
12.283,
24.25,
12.072,
23.937,
11.411,
23.875,
11.5,
23.875,
11.656,
11.528,
23.812,
11.144,
23.875,
11.306,
23.687,
23.562,
11.028,
10.111,
23.375,
9.1,
23.5,
8.772,
23.625,
9.106,
23.625,
10.1,
23.625,
23.625,
9.056,
9.483,
23.562,
23.562,
8.922,
8.511000000000001,
23.562,
8.078,
23.562,
7.9,
23.437,
23.437,
7.494,
23.5,
7.45,
7.794,
23.375,
23.5,
8.161,
23.437,
8.111,
23.375,
8.328,
8.45,
23.562,
23.812,
8.667,
23.937,
8.95,
9.728,
24.062,
11.511,
24.062,
24.062,
13.528,
14.489,
24.25,
24.5,
15.25,
16.044,
24.625,
17.344,
24.625,
18.489,
24.812,
18.033,
24.875,
17.878,
24.437,
18.678,
24.5,
17.383,
24.25,
17.194000000000003,
24.437,
24.687,
16.910999999999998,
24.562,
15.161,
24.375,
13.678,
12.922,
24.437,
12.806,
24.25,
24.25,
13.361,
24.062,
12.956,
23.937,
12.839,
24.0,
12.683,
24.0,
12.578,
12.606,
23.937,
12.717,
23.875,
12.55,
23.937,
12.233,
23.687,
12.7,
23.562,
12.906,
23.562,
12.422,
23.437,
11.856,
23.562,
11.005999999999998,
23.625,
10.811,
23.625,
10.239,
23.625,
10.006,
23.625,
9.833,
23.687,
10.072,
23.625,
23.562,
10.172,
23.5,
10.417,
23.5,
10.761,
23.5,
11.994000000000002,
12.078,
23.437,
11.411,
23.375,
9.9,
23.375,
9.894,
23.375,
10.522,
23.625,
12.6,
23.812,
12.889,
23.812,
13.361,
24.187,
14.706,
24.187,
23.937,
15.75,
17.522000000000002,
24.5,
18.706,
24.562,
19.456,
24.562,
19.556,
24.625,
24.187,
19.006,
24.375,
18.594,
17.867,
24.25,
24.125,
18.622,
18.444000000000003,
24.5,
24.625,
17.389,
24.562,
15.689,
24.5,
14.678,
14.178,
24.562,
13.961,
24.437,
13.767,
24.312,
12.978,
24.125,
24.312,
13.639,
13.533,
24.062,
12.85,
24.25,
13.461,
24.062,
24.0,
13.067,
13.517,
23.875,
13.039,
24.062,
11.683,
24.125,
23.875,
11.45,
23.687,
13.15,
12.706,
23.687,
23.625,
10.7,
9.794,
23.437,
23.625,
9.767,
23.687,
9.761,
23.5,
10.033,
10.672,
23.687,
23.75,
11.372,
23.625,
11.439,
23.687,
10.772,
23.687,
10.022,
23.562,
10.794,
23.625,
10.761,
9.983,
23.625,
9.572,
23.625,
9.717,
23.562,
10.222,
23.75,
10.567,
23.812,
10.444,
24.062,
10.556,
24.25,
12.4,
24.375,
14.3,
24.437,
24.625,
15.156,
15.594,
24.812,
16.094,
24.937,
16.855999999999998,
24.75,
18.011,
25.0,
18.55,
24.75,
18.506,
24.875,
24.75,
16.855999999999998,
15.994000000000002,
25.062,
25.0,
15.372,
24.625,
14.811,
24.875,
14.433,
14.0,
24.875,
13.678,
24.75,
13.956,
24.75,
24.5,
14.322,
14.294,
24.25,
24.437,
13.967,
14.144,
24.437,
24.0,
14.083,
24.0,
13.817,
13.6,
24.062,
13.489,
23.75,
13.367,
23.937,
23.937,
13.028,
23.875,
11.917,
11.333,
23.875,
23.875,
11.011,
23.625,
10.606,
23.687,
10.578,
23.375,
10.778,
10.556,
23.5,
10.567,
23.75,
10.772,
23.625,
23.687,
10.45,
23.625,
10.344,
10.5,
23.75,
10.122,
23.687,
9.872,
23.625,
9.85,
23.5,
9.306,
23.562,
10.761,
23.5,
10.239,
23.687,
11.578,
23.687,
23.937,
11.822,
24.125,
11.611,
12.978,
24.125,
16.861,
23.812,
24.125,
17.089000000000002,
23.75,
18.611,
19.917,
24.0,
24.062,
19.878,
23.937,
19.467,
20.172,
23.875,
20.1,
24.062,
19.783,
24.187,
19.511,
23.812,
17.167,
24.375,
16.933,
24.5,
24.0,
15.467,
15.589,
24.0,
14.422,
23.937,
14.083,
23.812,
23.875,
14.406,
14.722,
23.687,
14.556,
23.437,
14.294,
23.187,
23.187,
14.589,
14.167,
23.375,
13.772,
23.187,
13.428,
23.312,
23.187,
13.289,
12.889,
23.0,
12.044,
22.812,
11.717,
23.187,
22.875,
11.994000000000002,
12.25,
23.125,
11.961,
23.062,
10.817,
23.062,
23.062,
10.922,
10.978,
23.0,
11.144,
23.125,
11.2,
23.0,
10.989,
23.0,
10.378,
22.875,
11.394,
22.875,
11.872,
22.875,
10.889,
22.75,
10.522,
22.875,
10.883,
22.875,
9.972,
22.937,
10.489,
23.0,
11.144,
22.75,
13.028,
23.0,
22.875,
13.044,
16.239,
22.937,
14.411,
23.125,
15.039,
23.125,
16.544,
23.437,
14.389,
23.625,
13.417,
23.437,
22.937,
14.622,
23.125,
15.078,
23.437,
15.011,
13.706,
23.0,
23.187,
11.094,
23.187,
11.406,
22.937,
11.728,
23.062,
10.956,
23.062,
10.189,
22.937,
10.5,
22.812,
10.417,
22.937,
9.567,
22.937,
8.867,
22.812,
8.472000000000001,
22.875,
8.067,
22.687,
9.05,
22.75,
9.628,
22.75,
9.15,
22.75,
9.739,
22.687,
9.85,
22.75,
9.033,
22.75,
9.261,
22.75,
9.911,
22.687,
10.067,
22.562,
9.806,
22.687,
9.789,
22.562,
9.033,
22.625,
9.733,
22.625,
10.011,
22.687,
9.733,
9.322,
22.562,
9.189,
22.5,
8.367,
22.625,
7.767,
22.5,
7.582999999999999,
22.562,
7.561,
22.562,
7.45,
22.5,
7.528,
22.625,
8.056000000000001,
22.687,
8.622,
22.812,
9.194,
22.875,
10.228,
22.875,
12.817,
22.875,
13.989,
22.75,
14.528,
22.75,
14.8,
23.125,
14.806,
23.062,
16.25,
23.25,
17.778,
23.375,
23.562,
18.094,
17.044,
23.437,
23.437,
15.189,
14.289,
23.437,
14.211,
23.187,
13.011,
23.187,
23.5,
12.122,
23.375,
12.628,
23.187,
12.367,
11.867,
23.0,
11.717,
23.0,
11.611,
22.687,
12.156,
23.0,
12.35,
23.062,
23.062,
12.694,
22.875,
12.844,
23.0,
12.3,
22.875,
12.378,
22.875,
12.733,
13.394,
22.937,
13.194,
22.875,
12.061,
22.875,
12.417,
22.937,
13.117,
22.812,
12.561,
22.812,
12.817,
22.875,
13.267,
22.812,
13.089,
22.75,
13.078,
22.75,
12.828,
22.562,
22.75,
12.956,
22.75,
13.061,
22.75,
13.156,
22.687,
13.567,
22.75,
13.778,
22.625,
13.933,
22.812,
14.255999999999998,
22.437,
14.839,
15.611,
22.562,
16.494,
22.687,
17.656,
22.687,
19.267,
22.75,
20.089,
22.687,
20.783,
22.687,
21.444000000000003,
23.125,
21.256,
23.062,
21.9,
23.062,
22.478,
23.125,
22.428,
23.375,
22.333,
23.375,
21.322,
23.75,
20.639,
23.687,
20.417,
23.562,
19.328,
23.562,
18.906,
23.562,
18.517,
23.437,
18.583,
23.5,
18.922,
23.312,
18.311,
23.25,
18.561,
23.312,
17.805999999999997,
23.625,
16.439,
23.437,
23.5,
15.872,
23.562,
15.728,
23.562,
15.572,
23.312,
15.644,
23.375,
15.672,
23.437,
15.144,
23.562,
14.9,
23.125,
14.972,
23.187,
15.517,
15.022,
23.187,
15.917,
22.937,
16.6,
23.125,
16.078,
23.187,
14.689,
23.25,
14.45,
23.187,
14.533,
23.312,
14.572,
23.062,
15.761,
23.187,
14.767,
23.187,
14.022,
23.25,
13.883,
23.187,
14.072,
23.187,
14.111,
23.562,
14.433,
23.562,
14.878,
23.875,
15.283,
23.812,
16.311,
23.812,
18.911,
23.875,
20.117,
24.5,
20.506,
24.062,
20.633000000000003,
23.937,
21.611,
24.0,
21.983,
23.937,
22.628,
23.937,
23.789,
24.437,
23.044,
24.187,
21.306,
24.062,
20.617,
24.062,
20.317,
24.062,
18.478,
24.187,
16.994,
24.312,
16.417,
24.312,
16.506,
24.187,
24.062,
16.339000000000002,
23.875,
16.317,
23.75,
15.917,
24.125,
15.517,
23.875,
15.472,
14.817,
23.75,
14.894,
23.687,
23.562,
14.85,
23.437,
15.189,
23.375,
15.456,
16.317,
23.312,
23.375,
16.117,
15.789,
23.187,
23.312,
14.744000000000002,
23.375,
14.928,
23.375,
14.178,
13.389,
23.187,
23.0,
12.806,
23.062,
13.194,
22.875,
12.122,
23.125,
10.678,
23.062,
10.539,
10.311,
23.125,
23.0,
11.189,
23.062,
12.089,
23.0,
11.283,
12.161,
23.0,
23.0,
12.922,
23.0,
13.539,
23.125,
12.95,
23.062,
13.372,
23.0,
13.478,
23.0,
16.217,
23.125,
16.883,
17.206,
23.375,
18.1,
23.562,
23.375,
18.272,
18.183,
23.312,
18.067,
23.187,
17.683,
23.625,
18.261,
23.625,
18.478,
24.062,
16.894000000000002,
23.937,
15.956,
23.75,
15.644,
23.562,
15.8,
23.75,
16.2,
23.687,
16.061,
23.375,
16.1,
23.375,
16.344,
23.5,
23.5,
16.3,
16.139,
23.562,
23.437,
15.778,
15.283,
23.375,
13.744000000000002,
23.25,
12.978,
23.187,
23.187,
12.917,
23.375,
12.778,
23.062,
13.072,
13.422,
23.062,
23.25,
13.017,
23.125,
12.822,
12.639,
23.062,
23.187,
13.128,
23.125,
13.039,
13.539,
23.062,
23.062,
13.622,
13.478,
23.25,
23.125,
13.461,
13.556,
23.062,
23.062,
12.811,
23.062,
12.439,
12.228,
23.125,
23.062,
11.683,
11.633,
23.0,
23.062,
11.883,
23.187,
12.5,
13.539,
23.312,
14.505999999999998,
23.375,
15.406,
23.437,
15.511,
23.625,
16.444000000000003,
23.5,
16.511,
23.687,
24.125,
16.217,
16.861,
23.812,
16.833,
23.937,
24.437,
17.410999999999998,
17.65,
24.437,
17.311,
24.312,
24.437,
15.022,
14.3,
24.187,
24.312,
14.178,
12.394,
24.375,
10.667,
24.312,
10.639,
24.312,
10.378,
24.125,
24.0,
10.028,
9.728,
23.625,
23.312,
9.078,
23.375,
9.361,
8.994,
23.0,
9.039,
23.187,
8.667,
23.187,
8.406,
23.187,
23.187,
7.882999999999999,
7.528,
23.25,
7.3,
23.187,
23.25,
7.306,
23.125,
7.338999999999999,
23.062,
7.082999999999999,
6.811,
22.937,
6.806,
22.937,
22.75,
6.856,
6.861000000000001,
22.875,
22.937,
6.9110000000000005,
6.756,
23.125,
23.0,
6.694,
7.282999999999999,
23.0,
22.875,
7.522,
7.4,
22.75,
22.687,
7.5,
22.625,
7.272,
7.632999999999999,
22.687,
7.711,
22.687,
8.1,
22.75,
23.0,
8.488999999999999,
22.937,
8.994,
9.7,
23.062,
22.875,
9.478,
9.322,
22.812,
10.067,
22.75,
10.5,
23.0,
10.478,
22.937,
10.378,
23.0,
9.589,
23.062,
9.328,
23.187,
8.85,
23.187,
23.125,
9.256,
9.172,
23.187,
23.062,
9.089,
23.062,
8.988999999999999,
23.062,
8.889,
8.894,
23.062,
8.906,
23.0,
8.961,
22.75,
22.812,
8.661,
22.812,
8.706,
8.35,
22.687,
22.75,
8.656,
22.75,
9.267,
9.622,
22.75,
22.687,
9.867,
22.75,
10.183,
22.687,
10.311,
10.511,
22.625,
22.75,
10.755999999999998,
22.562,
11.111,
22.625,
11.317,
22.687,
11.511,
11.778,
22.625,
11.911,
22.625,
11.917,
22.625,
22.562,
11.861,
22.625,
11.944,
22.687,
11.983,
22.687,
12.078,
22.562,
12.283,
22.625,
12.25,
12.183,
22.687,
22.625,
12.005999999999998,
22.625,
11.706,
11.656,
22.625,
10.383,
22.625,
9.533,
22.562,
9.028,
22.562,
8.822000000000001,
22.687,
22.687,
9.294,
22.687,
9.878,
22.687,
9.867,
11.139,
22.625,
22.625,
11.472,
22.75,
11.3,
22.75,
11.05,
22.687,
12.583,
22.687,
11.356,
10.944,
22.687,
22.687,
10.528,
22.75,
10.194,
22.687,
9.95,
22.562,
9.589,
9.478,
22.687,
22.437,
9.15,
8.911,
22.437,
8.693999999999999,
22.437,
22.437,
8.427999999999999,
8.644,
22.5,
8.817,
22.437,
22.437,
9.1,
22.625,
9.339,
22.562,
9.256,
9.133,
22.437,
8.927999999999999,
22.5,
8.943999999999999,
22.375,
22.437,
9.083,
9.206,
22.5,
22.312,
9.406,
9.828,
22.437,
22.437,
9.95,
10.111,
22.312,
10.505999999999998,
22.375,
11.005999999999998,
22.375,
11.272,
22.437,
10.883,
22.375,
10.378,
22.375,
9.661,
22.437,
10.328,
22.375,
10.717,
22.562,
10.961,
22.437,
22.375,
11.011,
22.375,
11.061,
11.117,
22.437,
22.375,
11.2,
22.437,
11.389,
11.717,
22.375,
22.375,
11.772,
11.806,
22.437,
22.5,
11.839,
11.961,
22.437,
12.056,
22.437,
22.437,
12.356,
12.283,
22.375,
11.439,
22.437,
11.089,
22.5,
22.375,
11.561,
22.437,
11.689,
11.594,
22.437,
22.437,
11.4,
22.562,
10.533,
9.794,
22.375,
9.367,
22.5,
9.011,
22.5,
8.761000000000001,
22.5,
22.5,
8.467,
22.312,
8.272,
8.033,
22.562,
7.794,
22.312,
7.593999999999999,
22.625,
22.437,
7.506,
7.156000000000001,
22.375,
22.187,
7.05,
7.228,
22.25,
21.875,
6.882999999999999,
7.377999999999999,
22.187,
7.528,
22.062,
7.356,
22.0,
7.388999999999999,
22.125,
7.082999999999999,
22.0,
6.9670000000000005,
21.937,
7.022,
21.812,
22.0,
6.85,
22.0,
6.678,
21.937,
6.806,
6.882999999999999,
21.937,
21.875,
6.794,
21.937,
6.494,
6.093999999999999,
21.812,
21.812,
5.961,
21.875,
6.178,
6.567,
22.0,
22.25,
6.933,
22.625,
7.728,
22.625,
8.55,
10.467,
22.812,
22.812,
11.494000000000002,
11.567,
23.062,
23.0,
12.106,
22.937,
12.856,
23.375,
13.606,
13.755999999999998,
23.437,
23.375,
13.994000000000002,
23.437,
12.8,
11.567,
23.625,
23.562,
10.772,
23.5,
10.467,
23.312,
9.594,
8.7,
23.375,
23.187,
8.232999999999999,
23.125,
8.172,
23.187,
8.544,
23.062,
8.594,
8.722000000000001,
22.937,
9.239,
22.937,
9.339,
23.125,
9.156,
23.125,
8.033,
22.937,
7.656000000000001,
22.937,
7.778,
22.875,
8.022,
22.812,
8.506,
22.937,
8.55,
22.812,
8.661,
22.75,
22.812,
8.783,
22.875,
8.572000000000001,
8.527999999999999,
22.812,
8.883,
22.687,
22.75,
9.444,
22.562,
9.083,
7.972,
22.625,
22.687,
7.256,
7.8,
22.625,
22.625,
7.561,
7.733,
22.562,
22.562,
7.056,
8.167,
22.5,
7.656000000000001,
22.687,
8.133,
22.687,
9.039,
22.562,
22.562,
9.778,
22.625,
10.272,
10.544,
22.437,
12.35,
22.437,
12.15,
22.812,
22.812,
11.911,
23.0,
12.778,
23.125,
12.961,
14.339,
23.125,
23.187,
13.522,
23.187,
13.333,
13.517,
23.187,
14.072,
23.375,
23.187,
12.317,
11.639,
23.5,
10.7,
23.562,
9.722,
23.437,
23.375,
9.45,
23.312,
10.156,
23.25,
10.406,
10.472,
23.0,
10.383,
23.187,
10.228,
23.187,
22.812,
9.778,
9.272,
22.812,
22.625,
9.422,
22.812,
9.483,
22.562,
10.061,
22.5,
9.544,
22.375,
9.506,
9.333,
22.5,
8.817,
22.312,
8.333,
22.25,
8.511000000000001,
22.312,
8.722000000000001,
22.312,
22.062,
8.672,
8.311,
22.062,
21.875,
8.277999999999999,
21.875,
8.056000000000001,
21.687,
8.089,
21.687,
7.694,
21.625,
7.539,
7.338999999999999,
21.75,
7.343999999999999,
21.562,
21.437,
7.272,
21.375,
7.683,
21.375,
8.589,
9.028,
21.062,
21.187,
9.072,
9.867,
21.125,
21.312,
10.589,
12.183,
21.375,
12.839,
21.125,
13.283,
21.437,
21.5,
13.444,
21.5,
13.9,
14.211,
21.625,
14.806,
21.875,
21.875,
15.389,
22.062,
14.7,
13.283,
22.187,
12.511,
23.54979099016141,
23.619719757087047,
11.983,
23.608986322500023,
11.594,
23.520358744420268,
11.428,
23.416510565602188,
11.45,
12.206,
23.615486690938912,
23.699152846655192,
12.505999999999998,
11.944,
23.56520355228571,
10.844,
23.5495642410956,
10.761,
23.61468126234389,
11.139,
23.74402616580079,
11.161,
23.5754692707745,
11.244000000000002,
23.669569451195347,
10.728,
23.611111482798137,
23.572434115405148,
10.161,
23.601763512580188,
10.078,
23.595687543286672,
10.867,
10.894,
23.62009364364728,
10.772,
23.37797157285509,
23.56006969846177,
11.05,
23.61634872768611,
10.978,
10.889,
23.654682607239742,
23.471480193188206,
10.683,
23.62273280566571,
10.711,
23.60524055511849,
10.633,
10.55,
23.775157273951912,
23.52555415669,
10.283,
23.624197256226605,
9.589,
9.483,
23.72598560807381,
9.117,
23.598693094845316,
23.634615228266696,
8.889,
23.653070405106902,
8.717,
23.633908993911437,
8.867,
23.556852308995733,
9.106,
9.328,
23.576813520370195,
9.483,
23.707555499158836,
9.711,
23.67631416597668,
10.061,
23.618235769065937,
10.933,
23.61908254805882,
11.45,
23.607564292263465,
11.344,
23.527192319609245,
11.672,
23.677002204047174,
11.961,
23.610784989459944,
12.194,
23.666785061727296,
11.794,
23.799537733750583,
11.778,
23.59950345112988,
12.583,
23.700560817153708,
23.452681554880076,
12.411,
12.044,
23.556286604208704,
11.278,
23.62715630365704,
10.3,
23.535916078145235,
23.637898651786458,
9.683,
23.592169301044372,
8.806000000000001,
23.621618032694865,
8.583,
8.8,
23.60138900817509,
8.717,
23.64200921888788,
8.277999999999999,
23.52187945653744,
8.006,
23.634276784904632,
7.888999999999999,
23.62745173898868,
23.61167908632793,
8.044,
23.515407576774628,
8.006,
8.238999999999999,
23.611141079074155,
7.911,
23.634235660547574,
7.382999999999999,
23.58001688023696,
8.033,
23.46835105005229,
23.645959560732287,
7.882999999999999,
23.512033209504477,
7.917000000000001,
8.427999999999999,
23.61215391517681,
8.443999999999999,
23.61071103644337,
8.039,
23.639000555500825,
7.65,
23.64352333061355,
7.856,
23.484560119694528,
23.579889980929245,
8.389,
8.661,
23.58995734107729,
23.601967506871663,
9.05,
23.83673521953041,
9.206,
9.306,
23.64379926615844,
9.317,
23.49988237098269,
23.577546314520003,
8.911,
23.62631758678619,
8.467,
23.63830136608397,
8.089,
23.638728824314896,
8.722000000000001,
23.84321442301529,
8.8,
8.517000000000001,
23.456878198319888,
9.139,
23.746789981788275,
12.356,
23.77401799815785,
13.567,
23.68513144512824,
19.687,
14.861,
13.711,
21.187,
21.437,
14.206,
14.539,
21.625,
21.625,
14.122,
14.917,
21.937,
15.589,
21.937,
15.883,
22.0,
14.139,
21.937,
13.45,
22.062,
22.625,
13.128,
11.694,
22.562,
10.111,
22.437,
22.562,
9.567,
22.375,
9.772,
9.633,
22.375,
9.878,
21.937,
9.811,
21.937,
10.106,
21.937,
21.625,
9.672,
9.417,
21.875,
9.967,
21.75,
10.7,
21.812,
10.822,
21.625,
21.562,
9.706,
21.562,
9.306,
21.687,
8.839,
21.437,
8.517000000000001,
9.183,
21.375,
9.117,
21.437,
21.312,
8.45,
21.125,
7.989,
21.125,
7.289,
21.0,
7.75,
21.062,
8.228,
7.856,
20.875,
7.811,
20.812,
7.711,
20.75,
7.1,
20.812,
7.077999999999999,
20.75,
20.812,
7.093999999999999,
20.625,
6.822,
6.917000000000001,
20.625,
7.217,
20.687,
20.937,
7.011,
20.75,
7.922000000000001,
20.937,
11.878,
20.875,
13.106,
21.062,
14.222,
15.122,
21.125,
21.25,
15.317,
14.861,
21.312,
21.687,
15.2,
16.928,
21.437,
21.375,
16.433,
21.5,
15.328,
14.028,
21.75,
21.75,
13.239,
13.417,
21.687,
21.812,
12.822,
11.95,
21.937,
21.937,
11.672,
11.361,
21.812,
10.378,
21.75,
9.867,
21.625,
21.5,
9.972,
21.375,
10.028,
10.039,
21.375,
21.25,
10.083,
21.375,
9.689,
21.375,
10.056,
21.375,
9.628,
9.222,
21.375,
21.437,
9.467,
21.25,
9.717,
9.272,
21.187,
9.389,
21.062,
21.125,
9.328,
21.062,
8.806000000000001,
8.461,
21.125,
20.812,
8.522,
21.062,
8.693999999999999,
20.812,
8.317,
8.594,
20.812,
8.55,
20.687,
9.167,
20.687,
8.922,
20.687,
9.189,
20.625,
9.694,
20.5,
9.861,
20.687,
9.789,
20.687,
9.728,
20.687,
9.956,
20.5,
10.133,
20.875,
20.937,
12.689,
21.062,
13.289,
21.0,
14.067,
15.0,
21.125,
16.2,
21.25,
21.437,
16.872,
21.437,
17.461,
21.687,
17.456,
21.75,
17.805999999999997,
21.812,
18.033,
21.937,
15.772,
14.867,
21.937,
14.772,
22.0,
22.0,
13.939,
13.05,
22.187,
22.187,
12.539,
22.25,
11.417,
22.125,
11.644,
11.339,
22.062,
21.937,
10.539,
10.45,
21.875,
10.044,
21.812,
10.156,
21.75,
10.406,
21.812,
21.937,
10.233,
10.106,
21.687,
9.472,
21.625,
21.75,
9.444,
21.625,
9.028,
8.677999999999999,
21.625,
8.894,
21.5,
8.689,
21.562,
21.437,
8.411,
8.506,
21.25,
8.367,
21.125,
21.187,
8.628,
8.978,
21.125,
8.844,
21.125,
9.072,
21.062,
8.95,
21.0,
21.187,
8.772,
21.125,
8.027999999999999,
20.937,
7.317,
7.361000000000001,
20.937,
8.0,
20.687,
8.461,
21.0,
9.056,
21.25,
21.375,
9.722,
21.5,
12.878,
21.75,
13.439,
14.322,
22.0,
21.875,
15.339,
16.178,
21.937,
22.25,
16.9,
17.75,
22.187,
22.437,
18.656,
22.625,
17.605999999999998,
22.625,
17.633,
22.562,
16.611,
15.1,
22.5,
14.067,
22.687,
11.544,
22.687,
22.75,
9.994,
10.833,
22.375,
22.5,
10.417,
9.433,
22.312,
10.194,
22.375,
10.111,
22.062,
10.017,
22.375,
9.55,
22.187,
9.422,
22.0,
9.35,
21.937,
22.0,
9.461,
9.5,
21.812,
9.583,
21.937,
21.875,
9.389,
21.875,
9.239,
9.65,
21.812,
21.625,
9.856,
21.75,
9.2,
21.687,
9.167,
21.375,
9.072,
21.5,
9.339,
21.375,
8.933,
21.25,
8.15,
21.25,
7.606,
7.95,
21.125,
21.312,
7.827999999999999,
7.683,
21.0,
7.7,
21.125,
21.062,
7.483,
7.377999999999999,
20.937,
20.75,
7.528,
20.812,
7.922000000000001,
20.75,
8.094,
21.187,
8.738999999999999,
21.125,
11.206,
21.375,
11.261,
12.028,
21.5,
12.561,
21.5,
13.389,
21.5,
21.625,
14.122,
14.883,
21.625,
21.687,
14.728,
21.812,
14.755999999999998,
21.812,
15.106,
14.139,
22.0,
13.611,
22.0,
22.125,
13.167,
22.125,
12.411,
22.062,
10.928,
21.937,
10.25,
9.644,
22.312,
22.25,
10.255999999999998,
9.822,
22.125,
9.417,
22.0,
22.0,
9.683,
22.062,
9.283,
21.937,
9.2,
9.35,
22.0,
21.812,
9.006,
9.272,
21.812,
21.625,
9.367,
9.211,
21.625,
21.625,
9.2,
21.625,
9.111,
8.583,
21.375,
8.027999999999999,
21.5,
21.437,
8.306000000000001,
21.5,
7.722,
7.972,
21.437,
7.933,
21.375,
7.972,
21.062,
7.782999999999999,
21.25,
7.933,
21.062,
8.356,
21.125,
20.937,
8.383,
21.0,
7.838999999999999,
20.937,
7.739,
7.567,
20.812,
7.989,
20.937,
8.011000000000001,
20.937,
8.289,
21.562,
8.988999999999999,
21.25,
21.312,
11.233,
11.544,
21.5,
11.922,
21.375,
12.4,
21.562,
21.812,
13.328,
22.0,
14.161,
21.937,
15.005999999999998,
14.683,
22.125,
22.062,
14.294,
13.561,
21.937,
12.606,
21.937,
11.811,
21.937,
11.094,
22.0,
10.844,
22.0,
22.062,
10.956,
22.062,
11.183,
21.812,
11.583,
11.667,
21.687,
11.656,
21.875,
21.75,
10.528,
21.875,
8.961,
21.875,
8.344,
9.0,
21.687,
21.812,
9.456,
21.562,
9.211,
21.75,
9.161,
21.687,
8.927999999999999,
21.437,
8.217,
21.562,
8.439,
21.5,
8.267000000000001,
21.437,
8.189,
21.625,
8.3,
21.375,
7.877999999999999,
7.343999999999999,
21.437,
21.25,
6.978,
21.375,
6.794,
21.312,
6.632999999999999,
21.312,
6.556,
21.25,
6.167000000000001,
21.187,
6.017,
5.728,
21.187,
5.4670000000000005,
21.062,
5.056,
21.0,
5.556,
21.062,
6.017,
21.187,
20.937,
6.356,
6.827999999999999,
20.937,
7.417000000000001,
20.812,
7.967,
21.0,
9.272,
20.937,
21.062,
10.939,
11.906,
20.875,
21.0,
11.172,
21.25,
13.794,
21.25,
15.306,
21.5,
16.461,
17.294,
21.687,
15.533,
21.625,
15.6,
21.687,
14.5,
21.625,
12.539,
21.875,
12.161,
21.812,
13.217,
21.812,
12.05,
21.75,
11.167,
21.812,
21.75,
10.533,
11.222,
21.812,
21.687,
11.594,
21.812,
13.394,
21.812,
11.961,
11.344,
21.75,
21.875,
11.606,
21.937,
12.739,
11.244000000000002,
21.937,
10.539,
21.937,
12.406,
21.75,
13.183,
21.75,
11.922,
21.937,
12.378,
21.937,
21.75,
11.611,
21.812,
9.822,
12.233,
21.625,
12.2,
21.687,
12.55,
21.562,
21.562,
11.922,
11.194,
21.437,
21.5,
11.528,
21.375,
12.422,
11.311,
21.687,
9.878,
21.5,
11.022,
21.5,
11.2,
21.437,
12.306,
21.437,
21.312,
12.222,
21.187,
13.183,
13.461,
21.125,
21.312,
14.7,
14.2,
21.312,
21.437,
14.172,
13.522,
21.375,
21.375,
12.822,
21.312,
12.65,
21.437,
12.906,
21.437,
12.167,
21.437,
11.35,
10.922,
21.75,
21.625,
10.611,
21.625,
10.406,
21.562,
10.406,
10.406,
21.375,
10.328,
21.625,
21.437,
10.283,
10.378,
21.312,
21.437,
10.55,
21.375,
10.456,
21.375,
10.406,
21.312,
10.467,
10.556,
21.312,
21.187,
10.794,
21.437,
11.15,
21.437,
11.333,
21.25,
11.461,
21.375,
11.528,
11.533,
21.25,
11.439,
21.375,
11.322,
21.5,
21.25,
11.211,
11.211,
21.312,
21.437,
11.311,
11.217,
21.187,
21.375,
10.922,
10.722,
21.375,
10.233,
21.187,
9.733,
21.375,
9.5,
21.25,
9.533,
21.25,
21.187,
9.694,
9.733,
21.062,
21.25,
9.639,
21.187,
9.372,
21.187,
9.667,
9.867,
20.812,
10.3,
20.875,
10.467,
20.937,
20.875,
10.706,
12.261,
21.125,
12.833,
21.5,
21.375,
12.239,
12.378,
21.437,
14.044,
21.437,
13.828,
21.625,
14.722,
21.625,
21.75,
14.267,
21.75,
14.522,
21.75,
13.628,
12.633,
21.812,
12.45,
22.062,
12.028,
22.0,
10.656,
22.0,
22.0,
10.328,
21.875,
10.111,
10.106,
22.125,
9.667,
22.0,
9.628,
21.812,
9.767,
21.937,
21.75,
9.472,
9.256,
21.812,
8.982999999999999,
21.687,
9.156,
21.75,
21.625,
9.294,
21.75,
9.033,
21.875,
8.478,
8.988999999999999,
21.687,
21.562,
8.878,
8.611,
21.625,
21.5,
8.822000000000001,
21.562,
8.527999999999999,
8.517000000000001,
21.5,
21.437,
7.989,
21.312,
8.6,
21.5,
8.6,
21.25,
8.177999999999999,
21.375,
8.256,
8.25,
21.375,
8.0,
21.125,
21.125,
7.739,
7.632999999999999,
21.187,
7.528,
21.25,
7.827999999999999,
21.187,
8.406,
21.25,
21.062,
8.85,
20.937,
8.533,
21.062,
10.561,
21.25,
11.539,
13.172,
21.25,
14.094,
21.187,
21.437,
14.994000000000002,
21.5,
13.5,
21.75,
14.389,
21.875,
15.255999999999998,
21.937,
16.2,
15.967,
21.937,
14.211,
22.25,
11.572,
22.312,
22.187,
10.539,
22.312,
10.044,
22.312,
9.778,
9.589,
22.187,
9.611,
22.062,
22.0,
9.5,
8.927999999999999,
22.0,
21.937,
8.861,
21.812,
8.488999999999999,
21.687,
8.222000000000001,
8.339,
21.937,
7.939,
21.75,
7.722,
21.687,
21.875,
7.622000000000001,
7.717,
21.687,
7.983,
21.562,
21.562,
8.094,
21.562,
8.144,
8.283,
21.5,
21.25,
8.277999999999999,
21.375,
8.35,
7.294,
21.187,
21.437,
7.272,
7.05,
21.25,
21.25,
6.8,
6.827999999999999,
21.187,
6.832999999999999,
21.187,
6.706,
21.062,
21.062,
6.656000000000001,
6.789,
21.062,
21.25,
6.667000000000001,
21.0,
6.582999999999999,
21.125,
6.622000000000001,
6.806,
21.062,
6.85,
21.125,
20.75,
7.244,
8.443999999999999,
20.812,
20.75,
8.039,
20.75,
8.311,
20.75,
8.677999999999999,
21.187,
9.817,
10.189,
21.062,
21.187,
11.206,
21.25,
12.806,
21.312,
10.789,
21.187,
12.678,
21.562,
11.594,
11.333,
21.562,
10.878,
21.687,
10.255999999999998,
21.625,
21.562,
9.111,
8.294,
21.5,
21.562,
7.872000000000001,
7.528,
21.562,
21.5,
7.528,
7.332999999999999,
21.562,
7.661,
21.375,
7.667000000000001,
21.312,
7.689,
21.312,
8.0,
21.375,
21.25,
8.244,
8.183,
21.187,
21.5,
7.983,
21.062,
7.611000000000001,
21.125,
8.139,
8.022,
21.062,
7.678,
21.125,
7.077999999999999,
20.937,
21.062,
7.817,
8.2,
20.875,
7.772,
20.937,
20.937,
7.511,
7.35,
20.875,
7.872000000000001,
20.75,
8.033,
20.75,
8.139,
20.75,
20.75,
7.9,
20.562,
8.1,
20.687,
7.3,
7.194,
20.687,
7.417000000000001,
20.437,
7.867000000000001,
20.5,
7.244,
20.75,
20.812,
8.167,
20.812,
11.667,
20.875,
13.706,
14.733,
21.062,
15.028,
21.062,
14.422,
21.312,
21.5,
14.706,
21.5,
16.261,
21.687,
14.961,
21.875,
16.117,
21.812,
15.706,
15.994000000000002,
22.062,
14.833,
22.125,
21.937,
14.244000000000002,
13.317,
21.937,
22.125,
11.539,
21.937,
10.194,
22.187,
9.761,
10.106,
22.125,
22.0,
10.322,
10.15,
21.937,
10.394,
22.0,
21.875,
10.222,
21.812,
10.111,
9.994,
21.812,
21.75,
8.982999999999999,
8.683,
21.812,
9.189,
21.812,
9.061,
21.625,
8.232999999999999,
21.562,
7.4,
21.562,
7.517,
21.625,
21.562,
6.906000000000001,
21.375,
7.311,
7.861000000000001,
21.437,
21.375,
6.817,
5.944,
21.375,
6.089,
21.625,
6.077999999999999,
21.375,
5.761,
21.125,
6.172000000000001,
21.0,
21.062,
6.561,
6.906000000000001,
21.0,
20.937,
6.077999999999999,
21.0,
5.994,
20.75,
5.611000000000001,
6.167000000000001,
20.875,
7.517,
21.125,
8.0,
21.125,
21.062,
8.839,
20.937,
9.828,
10.817,
21.062,
21.312,
11.822,
12.094,
21.375,
12.406,
21.375,
12.606,
21.562,
13.239,
21.687,
21.875,
12.806,
21.875,
11.894,
10.683,
21.937,
22.187,
9.522,
9.194,
22.25,
8.988999999999999,
22.312,
8.689,
22.25,
22.125,
8.817,
21.937,
9.089,
21.937,
8.828,
8.756,
21.875,
8.539,
21.75,
21.812,
8.589,
8.622,
21.875,
8.744,
21.812,
8.917,
21.812,
21.625,
9.083,
9.25,
21.75,
21.687,
9.35,
21.562,
9.356,
21.625,
9.739,
9.322,
21.562,
9.183,
21.562,
8.494,
21.687,
21.437,
8.027999999999999,
7.689,
21.375,
21.375,
7.489,
7.338999999999999,
21.125,
21.125,
7.194,
7.077999999999999,
21.437,
21.25,
6.95,
21.187,
6.806,
21.25,
6.839,
7.022,
21.187,
21.062,
6.872000000000001,
20.937,
7.25,
20.812,
7.456,
7.989,
20.875,
21.125,
7.989,
20.937,
8.777999999999999,
20.937,
10.956,
21.125,
10.9,
21.437,
11.689,
21.437,
12.483,
21.562,
12.628,
13.822,
21.562,
21.812,
13.767,
21.75,
15.011,
21.937,
15.3,
22.187,
15.25,
14.494000000000002,
22.062
])))

print("Inside Model:")
with open("./inside_model/model_v3","rb") as o:
    inside_model: CustomRandomForestRegressor = pickle.load(o, encoding='bytes')
print(inside_model)


MEMORY_MAX = 100
outside_memory = []

app = FastAPI()

@app.post("/single")
async def single_prediction(body: SingleRequest):
    """ Takes in a single inside and outside temperature as input and predicts the posteriors. """

    curr_temp_out = body.current_temperature_outside

    with_inside = True
    if body.current_temperature_inside is None:
        with_inside = False
    else:
        curr_temp_in = body.current_temperature_inside

    if len(outside_memory) < MEMORY_MAX:
        outside_memory.append(curr_temp_out)
        outside_preds = outside_model.predict(np.array(outside_memory))
    else:
        outside_memory.pop(0)
        outside_memory.append(curr_temp_out)
        outside_preds = outside_model.predict(np.array(outside_memory))
    if with_inside:
        inside_preds = inside_model.total_predict(curr_temp_out, outside_preds, curr_temp_in)

    outside_preds = [ float(o[0]) for o in outside_preds ]
    if with_inside:
        inside_preds = [ float(o[0]) for o in inside_preds ]
        return JSONResponse(content=jsonable_encoder(
            {
                "OutsidePreds": outside_preds,
                "InsidePreds": inside_preds,
                "current_temperature_outside": curr_temp_out,
                "current_temperature_inside": curr_temp_in,
                "current_datetime": body.current_datetime
            }
        ))
    else:
        return JSONResponse(content=jsonable_encoder(
            {
                "OutsidePreds": outside_preds,
                "current_temperature_outside": curr_temp_out,
                "current_datetime": body.current_datetime
            }
        ))

@app.post("/batch")
async def batch_prediction(body: BatchRequest):
    """ Takes in a batch of outside temperatures and a single inside temperature
    as input and predicts the posteriors. """

    temp_seq_out = body.temperature_sequence_outside

    with_inside = True
    if body.current_temperature_inside is None:
        with_inside = False
    else:
        curr_temp_in = body.current_temperature_inside

    outside_preds = outside_model.predict(np.array(temp_seq_out))
    if with_inside:
        inside_preds = inside_model.total_predict(
                            temp_seq_out[-1],
                            outside_preds,
                            curr_temp_in
                        )

    outside_preds = [ float(o[0]) for o in outside_preds ]
    if with_inside:
        inside_preds = [ float(o[0]) for o in inside_preds ]
        return JSONResponse(content=jsonable_encoder(
            {
                "OutsidePreds": outside_preds,
                "InsidePreds": inside_preds,
                "temperature_sequence_outside": temp_seq_out,
                "current_temperature_inside": curr_temp_in,
                "current_datetime": body.current_datetime
            }
        ))
    else:
        return JSONResponse(content=jsonable_encoder(
            {
                "OutsidePreds": outside_preds,
                "temperature_sequence_outside": temp_seq_out,
                "current_datetime": body.current_datetime
            }
        ))

if __name__ == "__main__":
    uvicorn.run(app=app, host="127.0.0.1", port=9090, log_level="info")
